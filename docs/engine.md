# Игровой движок <!-- omit in toc -->

- [Базовые классы](#базовые-классы)
  - [Block](#block)
  - [Character](#character)
  - [Map](#map)
  - [Sprite](#sprite)
- [Классы игровых объектов и персонажей](#классы-игровых-объектов-и-персонажей)
  - [Pill, BigPill, Wall, Empty](#pill-bigpill-wall-empty)
  - [Pacman](#pacman)
  - [Enemy](#enemy)
- [Базовая логика движка](#базовая-логика-движка)

## Базовые классы

### Block

Абстрактный класс клетки игрового поля, содержит интерфейс, позволяющий отображать и обновлять игровое поле. От данного абстрактного класса наследуются такие классы как:

- Wall
- Pill
- BigPill
- Empty

Аргументы конструктора:

|       Имя       | Описание                         |
| :-------------: | :------------------------------- |
|    **image**    | Изображение блока                |
|  **position**   | Координаты блока на игровом поле |
| **elementSize** | Размер блока                     |
|  **cellSize**   | Размер клетки игрового поля      |
|  **clearCell**  | Функция для очистки блока        |

Абстрактные методы для реализации в классах наследниках:

|         Имя         | Описание                                                                                                                                                                                                                                                                                 |
| :-----------------: | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **checkCollisions** | Метод который использует функцию-хелпер `isCollidesSquare`, которая определяет, пересекаются ли два объекта. Метод принимает координаты и размер объекта и проверяет, пересекается ли этот объект с данным блоком. Используется в `renderFrame` для отслеживания столкновения c Пакмэном |
|      **draw**       | Метод, принимающий аргументом контекст и отрисовывающий в нем `image` на `position`                                                                                                                                                                                                      |

### Character

Абстрактный класс игрового персонажа, содержит интерфейс, позволяющий управлять поведением, перемещением и отображением персонажей. От данного абстрактного класса наследуются такие классы как:

- Pacman
- Enemy

Аргументы конструктора:

|        Имя        | Описание                                                                                                                                       |
| :---------------: | :--------------------------------------------------------------------------------------------------------------------------------------------- |
| **startPosition** | Начальная позиция персонажа на игровом поле, передается в координатах в матрице игрового поля и переводится в `px` для отрисовки внутри класса |
|    **sprites**    | Набор спрайтов для данного персонажа, для каждого направления передается отдельный спрайт                                                      |
|   **cellSize**    | Размер клетки игрового поля                                                                                                                    |
|     **field**     | Карта игрового поля                                                                                                                            |

Основные абстрактные методы для реализации в классах наследниках:

|        Имя         | Описание                                                                                                                                                                                                              |
| :----------------: | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **updatePosition** | Метод, пересчитывающий положение персонажа на каждом шаге                                                                                                                                                             |
|      **stop**      | Метод, останавливающий движение персонажа                                                                                                                                                                             |
|     **reset**      | Метод, возвращающий персонажа к исходным значениям позиции, направления, установленного спрайта                                                                                                                       |
|     **paint**      | Метод, принимающий аргументом контекст и отрисовывающий на нем текущий фрэйм текущего спрайта персонажа                                                                                                               |
|  **setNewSprite**  | Метод, принимающий параметром новый спрайт и устанавливающий его в активный спрайт персонажа, используется когда вследствие определенного события персонажу необходимо заменить анимацию, например Пакмэну при смерти |
|  **changeSprite**  | Приватный метод, который устанавливает персонажу корректный спрайт из списка `sprites` в соответствии с направлением движения                                                                                         |

### Map

Класс, который принимает текстовое описание карты, и исходя из него инициализирует все игровые блоки и персонажей. Также имеет методы, вычисляющие размер `canvas` и максимальное количество очков.

Аргументы конструктора:

|    Имя     | Описание             |
| :--------: | :------------------- |
| **mapUrl** | Текстовый файл карты |

Основные методы:

|        Имя         | Описание                                                                                    |
| :----------------: | :------------------------------------------------------------------------------------------ |
| **getMapAsBlocks** | Возвращает карту как массив экземпляров классов, унаследованных от `Block`                  |
|   **getPacman**    | Инициализирует и возвращает экземпляр класса `Pacman`                                       |
|   **getEnemies**   | Инициализирует и возвращает массив экземпляров класса `Enemy`                               |
| **getCanvasSize**  | Исходя из высоты и ширины карты а также `cellSize` возвращает размер `canvas`               |
| **getTotalPoints** | Возвращает суммарное количество баллов, которое можно получить собрав все таблетки на карте |

### Sprite

Класс для работы с анимированными изображениями.

Аргументы конструктора:

|      Имя      | Описание                                                                              |
| :-----------: | :------------------------------------------------------------------------------------ |
|   **image**   | Изображение спрайта                                                                   |
| **canvasPos** | Координаты по которым будет отрисован спрайт                                          |
|    **pos**    | Координаты участка `image`, который будет отрисован                                   |
|   **size**    | Размер спрайта                                                                        |
|   **speed**   | Скорость анимации спрайта                                                             |
|  **frames**   | Массив очередности кадров                                                             |
|   **once**    | Булевое значение, определяющее будет ли анимация показана 1 раз, либо будет зациклена |

Основные методы:

|    Имя     | Описание                                                                                                             |
| :--------: | :------------------------------------------------------------------------------------------------------------------- |
| **update** | Метод, который вызывается на каждом цикле отрисовки канваса, он прокручивает кадры на переданном в класс изображении |
| **render** | Метод, отрисовывающий на канвасе текущий фрэйм переданного в класс изображения                                       |

Пример использования:

```js
const sprite = new Sprite(
  icons.sprite,
  {
    x: x,
    y: y,
  },
  { x: 0, y: 3 * cellSize },
  { x: cellSize, y: cellSize },
  1,
  [0, 1, 2, 3, 4, 5, 6, 7, 8]
);
```

## Классы игровых объектов и персонажей

### Pill, BigPill, Wall, Empty

Данные классы унаследованы от абстрактного класса `Block`, они служат для отображения и обновления текущего состояния игрового поля, которое состоит из матрицы данных элементов.

Все эти классы , за исключением `Empty` вызывают конструктор родителя, передавая туда соответствующие им размеры блока и изображения.
`Empty` в свою очередь не передает размера блока и изображения, за счет чего отрисовывается как черный квадрат.

`Pill` и `BigPill` переопределяют унаследованный метод `checkCollisions`:

```js
  checkCollisions(x: number, y: number) {
    if (super.checkCollisions(x, y)) {
      this.clearCell();
      return true;
    }
    return false;
  }
```

Таким образом при столкновении с Пакмэном клетки `Pill` и `BigPill` перезапишутся на `Empty`

### Pacman

Класс игрового персонажа, которым управляет пользователь, унаследован от `Character`.

Расширяет конструктор `Character` параметром `direction`, который отвечает за направление движения Пакмэна.

Новые методы:

|         Имя         | Описание                                                                                                                                                                                                                                                                                                                                  |
| :-----------------: | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **updateDirection** | Метод запускается при нажатии пользователем стрелок на клавиатуре, отвечает за смену направления движения Пакмэна. Если мы меняем направление на противоположное, то изменение применяется моментально. Если мы меняем направление на противоположное, то изменение направления будет осуществлено при прохождении Пакмэном центра клетки |
|   **getIsStill**    | Метод вернет значение true если Пакмэн стоит на месте                                                                                                                                                                                                                                                                                     |

Переопределенные методы:

|        Имя         | Описание                                                                          |
| :----------------: | :-------------------------------------------------------------------------------- |
| **updatePosition** | Добавляется проверка на возможность прохождения Пакмэном по заданному направлению |
|     **reset**      | Добавляется сброс направления движения Пакмэна                                    |

### Enemy

Класс врага, унаследованный от `Character`. Создается несколько экземпляров данного класса.

Расширяет конструктор `Character` следующими параметрами:

|        Имя         | Описание                                             |
| :----------------: | :--------------------------------------------------- |
|      **path**      | Путь, по которому перемещается враг                  |
| **activationTime** | Время с начала игры, через которое враг активируется |

Новые методы:

|      Имя       | Описание                                                                                                                                                                        |
| :------------: | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **updateTime** | Метод для управлением времени до начала активации врага, при помощи него внутренний таймер увеличивается в общем цикле игры `renderFrame` и обнуляется при вызове `reset` врага |

Переопределенные методы:

|        Имя         | Описание                                                                          |
| :----------------: | :-------------------------------------------------------------------------------- |
| **updatePosition** | Добавляется проверка на возможность прохождения Пакмэном по заданному направлению |
|     **reset**      | Добавляется сброс направления движения Пакмэна                                    |

## Базовая логика движка

В класс `Map` передается текстовый файл карты, в котором заложено положение всех блоков и персонажей на карте.

```js
### ##### ###
#*#...#...#*#
 .##.###.##.
#..   G   ..#
/* ... */
```

`Map` преобразует карту к виду

```js
Wall    Wall    Wall    Empty   Wall    Wall    Wall    Wall    Wall    Empty   Wall    Wall    Wall
Wall    BigPill Wall    Empty   Empty   Empty   Wall    Empty   Empty   Empty   Wall    BigPill Wall
Empty   Pill    Wall    Wall    Pill    Wall    Wall    Wall    Pill    Wall    Wall    Pill    Empty
Wall    Pill    Wall    Empty   Empty   Empty   Wall    Empty   Empty   Empty   Wall    Pill    Wall
Wall    Wall    Wall    Empty   Wall    Wall    Wall    Wall    Wall    Empty   Wall    Wall    Wall
Wall    Pill    Wall    Empty   Empty   Empty   Empty   Empty   Empty   Empty   Wall    Pill    Wall
/* ... */
```

где каждый элемент это экземпляр класса, унаследованного от `Block`.

Также `Map` содержит методы инициализирующие и возвращающие всех персонажей, которые являются экземплярами классов, унаследованных от `Character` (`Pacman, Enemies`)

В основом файле движка - `Canvas.tsx` при помощи `requestAnimationFrame` циклически запускается функция `renderFrame`, в которой:

- получаем текущее положение Пакмэна
- проходимся по карте экземпляров `Block`, проверяя столкновение с Пакмэном, в случае которого, если текущий блок это `Pill` или `BigPill`, мы добавляем очки к текущему счету и перезаписывает текущую ячейку карты
- проходимся по массиву всех врагов (экземпляры `Enemy`), также проверяя на столкновение с Пакмэнов, в случае которого запускается функция `handleDeath`
- запускаем отрисовку карты, Пакмэна и врагов
- запускаем обновление позиции Пакмэна и врагов
